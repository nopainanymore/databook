# 第五章、虚拟机栈

[toc]

## 概述

### 出现背景

![image](https://static.lovedata.net/20-11-08-08179c49011f764b77dc5e036f61f0be.png-wm)

![image](https://static.lovedata.net/20-11-08-7d344755b2567ead7fa316214b127442.png-wm)



![image](https://static.lovedata.net/20-11-08-9ab9746c1adb7a52a9f07a73bc9e4330.png-wm)



### 举例-栈

![image](https://static.lovedata.net/20-11-08-e78e751a8505056bed06057380470271.png-wm)

![image](https://static.lovedata.net/20-11-08-f8c4156ff3fe0597542da35bccc68518.png-wm)



![image](https://static.lovedata.net/20-11-08-e4ca78cab485ff964723ca125ec25c4b.png-wm)

![image](https://static.lovedata.net/20-11-08-4d42be548d6fd7952866de2e03f0275f.png-wm)

![image](https://static.lovedata.net/20-11-08-24740957a6bc60c1a5f7e1b0d49714f2.png-wm)

### 栈大小设置举例

![image](https://static.lovedata.net/20-11-08-366edcb768f8750b4ade90b7cc94e620.png-wm)

## 栈的存储单位

![image](https://static.lovedata.net/20-11-08-d8e84b64f18a7a0fc8cbff6215664858.png-wm)



![image](https://static.lovedata.net/20-11-08-680e4311ae67b6941fdd83fc1f54a5e3.png-wm)

![image](https://static.lovedata.net/20-11-08-517dd7e724e674107e9e9a24fcd63d9c.png-wm)



![image](https://static.lovedata.net/20-11-08-e754eb69bbe7f1a9242f7c0d3e231feb.png-wm)



### 栈帧的内部结构

![image](https://static.lovedata.net/20-11-08-035d1ec39a438d8025d64b1783f3cc19.png-wm)



## 局部变量表

![image](https://static.lovedata.net/20-11-08-306f217c806a3d2134c7f2b5f52736bb.png-wm)

![image](https://static.lovedata.net/20-11-08-5366d65d8e5c6a1e03840f739ad0420c.png-wm)

![image](https://static.lovedata.net/20-11-08-3fbf1846e9d39766e06855651bc584ed.png-wm)



### 关于Slot的理解

![image](https://static.lovedata.net/20-11-08-2f337908ab616577dc176cdf79416893.png-wm)

> 在构造函数或者实例方法中，能调用this，因为this在本地变量表中

![image](https://static.lovedata.net/20-11-08-54e04e0360b83161532bd6faa5b2f4a9.png-wm)

![image](https://static.lovedata.net/20-11-08-4ecc9652f6cc85ac7ef1cf73813f470f.png-wm)

![image](https://static.lovedata.net/20-11-08-f5fba81331554f1b232a91acb4fecd1b.png-wm)

> Double类型占据两个槽

![image](https://static.lovedata.net/20-11-08-d881821ac80c4a4c4830353888d7ac94.png-wm)



### Slot槽的重复利用问题

![image](https://static.lovedata.net/20-11-08-6d6a156eeb4a67cab1e4cea1f98c3798.png-wm)

![image](https://static.lovedata.net/20-11-08-970b6733592efbbb61b8f9095db478c5.png-wm)

#### 静态变量与局部变量的对比

![image](https://static.lovedata.net/20-11-11-ec9d80d144c339f68bb8342d601d699b.png-wm)

![image](https://static.lovedata.net/20-11-11-6c047149e813c31d3a8a135f37c026ab.png-wm)

![image](https://static.lovedata.net/20-11-11-ffcf6d87a2d45d9bcdc8db59b5749d48.png-wm)



#### 补充

![image](https://static.lovedata.net/20-11-11-94f36c9501332e0c4d6e0d567888cc0f.png-wm)

## 操作数栈(Operand Stack)

![image](https://static.lovedata.net/20-11-11-166e71aad4f9e56b04999e8852add581.png-wm)





![image](https://static.lovedata.net/20-11-11-ed5ad2d5b8bc1e89ff91e34caf0a3cf8.png-wm)

![image](https://static.lovedata.net/20-11-11-42c5d5097ab53b4ef758d4da0187be9f.png-wm)

### 代码追踪

![image](https://static.lovedata.net/20-11-11-847e0f95b18b0f456826f5411a5bb5d3.png-wm)

![image](https://static.lovedata.net/20-11-11-f592fad9027d369373dcfbc326b5237f.png-wm)

刚开始。PC 操作数栈指向的是0，下一条要执行的是0这个指令，局部变量表也是空的，操作数栈是0

然后执行0，操作数栈变为15，然后PC寄存器往下移动，变为了2

然后store，就是一个出栈的操作，将15这个值放在了局部变量表index 1 这个位置(为什么上来就是1，因为实例方法，的地0个是this变量，指向对象本身)，这个时候操作数栈是没有了。

![image](https://static.lovedata.net/20-11-11-25c31beec614e6c59efdb2b4dda1e4cb.png-wm)

然后又bipush 8 ，放入操作数栈，

然后继续 istore_2 把8放入到局部变量表里面

![image](https://static.lovedata.net/20-11-11-a9c968e30c08537f71e3475da0e3881e.png-wm)



然后 iload_1 iload_2 将局部变量表中 索引为 1 和2 的 值load出来，放入到操作数栈

![image](https://static.lovedata.net/20-11-11-7b161370444b3fd6d95f92e72fc61beb.png-wm)

iadd 直接又 执行引擎翻译为机器质量， 从操作数栈中弹出两个值，即算完成后，放入到操作数栈

istore_3 将 23 存入到局部变量表index为3的地方

所以 ，对应上了 局部变量表的长度为4，操作数栈的最大深度为2

![image](https://static.lovedata.net/20-11-11-8313b3cb85518b515bb1dcdc2d5da7f8.png-wm)



![

](https://static.lovedata.net/20-11-11-18aebf829def01136f3c609ecbeddd06.png-wm)

可以看到， 15 8 都是bipush ，因为byte可以存的下，而800就是 sipush ，是转换为short的。 而long  float double 则是自己的类型，

![image](https://static.lovedata.net/20-11-11-f214e7c777f422fc628577ff07e1b862.png-wm)



#### 返回值的问题

一上来就是 aload 放入到操作数栈的位置，需要将上一个方法的返回值放入操作数栈，做后面的操作

![image](https://static.lovedata.net/20-11-11-4dc24c6f2bda17693df82ada49375934.png-wm)

![image](https://static.lovedata.net/20-11-11-73350ebea65a9744d036e32185041e0e.png-wm)



## 栈顶缓存技术(Top of stack casing)

![image](https://static.lovedata.net/20-11-11-a6cc26ad26f5eb93524c1b73b325fbc3.png-wm)

## 动态链接

## 方法的调用：解析与分派

## 方法返回地址

## 一些附加信息

## 栈的相关面试题



